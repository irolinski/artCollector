<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collected</title>
    <base href="/" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href='public/stylesheets/collection.css'/>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js" integrity="sha384-fbbOQedDUMZZ5KreZpsbe1LCZPVmfTnH7ois6mU1QK+m14rQ1l2bGBq41eYeM/fS" crossorigin="anonymous"></script>       
    <link rel='stylesheet' href='https://cdn.datatables.net/1.13.5/css/dataTables.bootstrap5.min.css'>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <!-- Font Awesome CSS -->
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css'>
    
</head>

<!-- add a constant row height maybe?-->

<body class="d-flex flex-column vh-100">
    <%- include('./partials/navbar.ejs')  %>
    
    <main class="container mt-5">
        <%- include('./partials/flash.ejs')  %>

<h1> My Collection </h1>

        <div>
    <a href="collection/new">Add a New Piece!</a>  
<form id="collection_form" class="to_be">
        <label for="archival-select">Archival:</label>
            <select name="archival" id="archival-select" onchange="this.form.submit()">
                <option value="archival-hide" <% if (archivalStatus === "archival-hide" ) { %> selected="selected" <% } %> >Hide</option>
                <option value="archival-show" <% if ((archivalStatus === "archival-show") || (archivalStatus === undefined)) { %> selected="selected" <% } %>>Show</option>
                <option value="archival-showOnly" <% if (archivalStatus === "archival-showOnly") { %> selected="selected" <% } %>>Show Only </option>

            </select>

        <label for="categories">Manage Categories:</label>
        
            <div id="categories">
        <input type="checkbox" class="category-check" value="1"  name="added" id="checkbox0" onchange="this.form.submit()" <% if (queryString.includes('added')) { %> checked="checked" <% } %>/>
        <label for="#checkbox0"> Added </label>

        <input type="checkbox" class="category-check" value="1" name="acquired" id="checkbox1" onchange="this.form.submit()" <% if (queryString.includes('acquired')) { %> checked="checked" <% } %>/>
        <label for="#checkbox1"> Date acquired </label>

        <input type="checkbox" class="category-check" value="1" name="forSale" id="checkbox2" onchange="this.form.submit()" <% if (queryString.includes('forSale')) { %> checked="checked" <% } %> />
        <label for="#checkbox2"> For Sale </label>

        <input type="checkbox" class="category-check" value="1" name="arch-col" id="checkbox3" onchange="this.form.submit()" <% if (queryString.includes('arch-col')) { %> checked="checked" <% } %> />
        <label for="#checkbox3"> Archival </label>

        <input type="checkbox" class="category-check" value="1" name="catalogue" id="checkbox4" onchange="this.form.submit()" <% if (queryString.includes('catalogue')) { %> checked="checked" <% } %> />
        <label for="#checkbox4"> Catalogue Number </label>
    </div>
</form>

<form action="/preferences/edit?_method=PUT" method="POST" novalidate>
    <input type="hidden" name="custom_table" value="<%=queryString%>" />
 <button type="submit"> Set current settings as default </button> 
</form>







<table id="example" class="table table-striped" style="width:100%">
    <thead>
        <tr>
            <th>Artist</th>

            <th>Title</th>

            <th>Thumbnail</th>

            <th>Medium / Size</th> 

            <th>Year</th>

            <% if (queryString.includes('added')) { %> <th>Added</th> <% } %>

             <th <% if (!queryString.includes('acquired')){ %> style="display:none;"  <% } %> >Acquired</th>

            <% if (queryString.includes('forSale')){ %> <th>For Sale</th> <% } %>

            <% if(queryString.includes('arch-col')){ %> <th>Archival</th> <% } %>

            <% if(queryString.includes('catalogue')){ %> <th>Catalogue Number</th> <% } %>


        </tr>
    </thead>
    <tbody>

        <% for (let piece of artPieces) { %>
        
            
                <tr>
                    <td><%= piece.artist %></td>

                    <td> <a href="collection/show/<%=piece.id%>"> <%= piece.title %> </a> </td>

                    <td>
                        <% if (piece.images.length > 0) { %>
                        <% for (let img of piece.images) { %>
                    <img src="<%= img.url %>" style="max-width:100px; width:100%">
                        <% break } %> 
                        <% } else { %> <img class="" style="width:100px; height:100px;" src="https://res.cloudinary.com/dtjtqp7r1/image/upload/v1699819800/artCollector/No_image_3_hjnpkx.png"> 
                        <% } %>

                    </td>


                   
                    <td>
                        <%= piece.medium %> <br>                     
                        <% for (let s of piece.size) { %>
                            <% if ((s.x === null || s.y === null) || (s.x === undefined || s.y === undefined)) {  null  } else { %>
                        <% if (s.z === undefined || s.z === null){ %>
                             <%=  `${s.x} x ${s.x} ${s.unit}` %> 
                    <%  } else { %>
                        <%=  `${s.x} x ${s.y} x ${s.z} ${s.unit}` %>
                        <% } %>
                    <% break } %>
                    <% } %>
                    </td>



                        <% for (let y of piece.year) { %>
                            <% if (y.year_started != undefined || y.year_stared != null) { %>
                                <td> <%= `${y.year_started} - ${y.year_finished}` %> </td>
                        <%  } else { %>
                            <td><%= y.year_finished %></td>
                            <% } %>
                        <% break } %>
               

                        
                
            
                  <% if (queryString.includes('added')) {   %>       
                    <td>

                    <span style="display: none"> <%= piece.createdAt.getTime() %> </span> 
                  <%=  moment (piece.createdAt).fromNow() %> 
                </td>

                  <% } %>


                        <td <% if (!queryString.includes('acquired')){ %> style="display: none;"  <% } %> >
                            <% if (piece.acquiration_date) { %>
                        <span style="display: none">   <%= piece.acquiration_date.getTime() %>    </span> 
                            <%=  moment(piece.acquiration_date).format("DD/MM/YYYY")%>
                            <% } else { %> no info <% } %>
                        </td>

                    <% if (queryString.includes('forSale')){ %> 
                        <td>
                            <% if (piece.forSale == true) { %>
                                <% for (let el of piece.price) { %>
                                  <%  if (el.price !== null) { %>
                                     <%= `${el.price} ${el.currency}` %> 
                                     <% } else { %>
                                        not set
                                   <% }}} else { %>
                                        &#10007;
                                        <% } %>                         </td>
                    <% } %>

                    <% if (queryString.includes('arch-col')) { %>
                    <td><% if (piece.archival == true) { %> &#10003; <% } else { %> &#10007; <% } %></td>
                    <% } %>


                    <% if (queryString.includes('catalogue')) { %>
                        <td><%=  piece.catalogue %></td>
                        <% } %>


                </tr>
        <% } %>
    </tbody>
</table>

</div>
</main>
</body>



<!-- jQuery -->
<script src='https://code.jquery.com/jquery-3.7.0.js'></script>

<!-- Data Table JS -->
<script src='../public/javascripts/dataTables.js'></script>
<script src='../public/javascripts/dataTables_responsive.js'></script>
<script src='https://cdn.datatables.net/1.13.5/js/dataTables.bootstrap5.min.js'></script>

<script>

//set user default categories
window.onload = (function() { 

    var userTable = '<%- JSON.stringify(userTable) %>'
    var queryString = '<%- JSON.stringify(queryString) %>'
   
    if 
   (((!queryString.includes('added') && !queryString.includes('catalogue') && !queryString.includes('acquired') && !queryString.includes('arch-col') && !queryString.includes('forSale')) && (queryString.includes('archival-hide') || queryString.includes('archival-show') || queryString.includes('archival-showOnly')))) {
    localStorage.setItem('noBoxesChecked', true)} else { localStorage.removeItem('noBoxesChecked')};

    if (localStorage.getItem("defaultCollectionSettings") === null && localStorage.getItem("noBoxesChecked") === null) {

        const checkboxes = document.querySelectorAll(".category-check");

        for (let el of document.querySelectorAll('.category-check')) {
            if (!queryString.includes("1")){
            if (userTable.includes(el.name)){ el.checked = 1 } else { 
                el.checked = 0 
        }          // new condition

    }}

             

        for (let o of document.querySelector("#archival-select")) {
           if (!queryString.includes("1")) {
            if (userTable.includes(o.value)){ o.selected = 1 } else {
                o.selected = 0
            }
           }
        }


     document.querySelector('#collection_form').submit();
    //  if (localStorage.getItem("noBoxesChecked") === null ){
     localStorage.setItem("defaultCollectionSettings", true) //};

} else {
    localStorage.removeItem('defaultCollectionSettings');
}})






    $(document).ready(function() {
        $('#example').DataTable({
            "columnDefs": [
                { "orderable": false, "targets": [2, 3]}
            ],
            order: [[5, 'desc']],

        language: {
            //customize pagination prev and next buttons: use arrows instead of words
            'paginate': {
            'previous': '<span class="fa fa-chevron-left"></span>',
            'next': '<span class="fa fa-chevron-right"></span>'
            },
            //customize number of elements to be displayed
            "lengthMenu": 'Display <select class="form-control input-sm">'+
            '<option value="10">10</option>'+
            '<option value="20">20</option>'+
            '<option value="30">30</option>'+
            '<option value="40">40</option>'+
            '<option value="50">50</option>'+
            '<option value="-1">All</option>'+
            '</select> results'
        }
        })  
    }); 


    
</script>


</body>
</html>


