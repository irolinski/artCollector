<% layout('layouts/boilerplate')%>


<div class="row py-5 my-5 mx-4">

    <!-- left column -->
    <div class="col-md-6" id="left-column">

        <!-- image -->
        <% if (p.images.length > 0) {  %>

        <div id="carousel" class="carousel slide" data-ride="carousel">
            <div class="carousel-inner">
            <% p.images.forEach((img, i) => { %>
            <div class="carousel-item <%= i === 0 ? 'active' : ''%>" id="item<%=i%>">
                <img class="image" crossorigin="anonymous" src="<%=img.url%>" alt="" id="image_<%=i%>">
            </div>
            <% }) %>
            </div>
            <% if (p.images.length > 1) { %>
            <button class="carousel-control-prev" type="button" data-bs-target="#carousel" data-bs-slide="prev" onclick="btn_check_landscape_prev()">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#carousel" data-bs-slide="next" onclick="btn_check_landscape_next()">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            </button>
            <% } %>
        </div>
        <% } else { %>
            <img id="no-image-placeholder" src="https://res.cloudinary.com/dtjtqp7r1/image/upload/v1699818280/artCollector/No_image_xoyq1z.png"> 
        <% } %>
        </div>



    <!-- right column -->
    <div class="col-md-6">

        <!-- main detail section -->
        <div class="container pt-5" id="detail-section">
            <div class="card-body pb-4">
                <p> </p>
                <p> <span class='fw-bold'> <%= p.artist %> </span> <% if (p.catalogue) { %>  <span class=" ps-5 ms-5 card-subtitle text-muted">Catalogue Number: <%= p.catalogue %></span> <% } %> </p>

            <p class="">
                    <span class="fw-bold fst-italic">
                        <%= p.title %>,
                    </span>
                    <span id="year-span">
                        <% for (let y of p.year) { %>
                            <% if (y.year_started != undefined || y.year_stared != null){ %>
                                <%= `${y.year_started} - ${y.year_finished}` %> 
                        <%  } else { %>
                            <td><%= y.year_finished %></td>
                            <% } %>
                        <% break } %>
                    </span>
                </p>



                <p class="card-subtitle mb-2 text-muted"> 
                    
                    <%= p.medium  %>,
                    <span id="size-span">
                
                            <% for (let s of p.size) { %>

                                <% if (s.x === undefined || s.x === null || s.y === undefined || s.y === null){ %>
                                        Size unknown
                               <% } else { %>

                            <% if ((s.z === undefined) || (s.z === null)){ %>
                                <%=  `${s.x} x ${s.x} ${s.unit}` %> 
                        <%  } else { %>
                            <%=  `${s.x} x ${s.y} x ${s.z} ${s.unit}` %>
                            <% } %>
                        <% break } }%>
                    </span>
                </p>
            </div>
            <div>
            <p class="accordion pb-2" data-bs-toggle="collapse" id="description_accordion" href="#collapseTwo" onclick="toggleClass('active', 'description-arrow')"> Description <span class="menu-arrow" id="description-arrow">&#9660;</span></p> 
            <div id="description_wrapper" class="pb-4">
                    <div id="collapseTwo" class="collapse container" data-bs-parent="#description_accordion">
                        <% if (p.description !== '') { %>
                        <%= p.description %> 
                        <% } else { %>
                            <p class="text-muted"> No description added for this piece. </p>
                            <p class="text-muted"> (You can, however, add some by editing!)</p>
                    <%  } %>
                    </div>
                </div>
            </div>


            <!-- ownership details section -->
                <div>
                    <p class="accordion pb-2" data-bs-toggle="collapse" id="owner_detail_accordion" href="#collapseOne" onclick="toggleClass('active', 'ownership-detail-arrow')"> Ownership Details <span class="menu-arrow" id="ownership-detail-arrow">&#9660;</span> </p>
                    <div class="pb-4"  id="piece-info-div">
                    <div id="collapseOne" class="collapse container " data-bs-parent="#owner_detail_accordion">
                        <div class="row pb-4">
                            <div class="col-md-9 pb-4">

                                <% for (let o of p.owner) { %>
                                    <% for (let h of p.holder) { %>
                                <%     if (o.name === h.name) {  %>

                                <% for (let o of p.owner ) { %> 
                                    <% if (o.status === 'self') { %>
                                    <%  if (currentUser.show_name !== '' && currentUser.show_name !== null)  { %>
                                        <div> 
                                            Owner/Holder: <span id="owner-span"><%= `${currentUser.show_name}` %></span> <br><br>

                                            <span id="o-contact-span"> <%= `Contact: ${currentUser.contact_info}` %></span> <br><br>
                                            Acquiration date: <%=  moment(p.acquiration_date).format("DD/MM/YYYY") %>
                                        </div>
                                    <% }} else if ( o.name !== undefined && o.name !== '') {%>
                                        <% if (o.contact_info !== '') { %> 
                                            <div>  
                                                Owner/Holder: <span id="owner-span"><%= `${o.name}` %></span> &emsp; <br>
                                                <span id="o-contact-span"><%= `Contact: ${o.contact_info}` %></span> </div>
                                        <% } else { %>
                                            <p> No info on ownership status of this piece </p >                                       
                                                <% } %>
                                                <% } else { %>
                                                <% } %>
                                    <% break } %>
                                    <% } else {  %>
                                        
                                <% for (let o of p.owner ) { %> 
                                    <% if (o.status === 'self') {
                                        if (currentUser.show_name !== '' && currentUser.show_name !== null)  { %>
                                        <div> 
                                            Owner: <span id="owner-span"><%=`${currentUser.show_name}` %></span> <br>
                                            <span id="o-contact-span"><%=`Contact: ${currentUser.contact_info}` %></span> </div>
                                    <% }} else if ( o.name !== undefined && o.name !== '') {%>
                                        <% if (o.contact_info !== '') { %> 
                                            <div>
                                                Owner:<span id="owner-span"><%=`${o.name}`%></span> &emsp; %> <br>
                                                <span id="o-contact-span"> <%= `Contact: ${o.contact_info}` %></span> </div>
                                        <% } else { %>
                                            <p> No info on Owner </p >                                       
                                                <% } %>
                                                <% } else { %>
                                                <% } %>
                                    <% break } %>
                                <p></p>

                                <% if (p.acquiration_date !== false) { %>
                                <p> Acquiration date: <%=  moment(p.acquiration_date).format("DD/MM/YYYY") %></p>
                                <% } %>
                                
                                <% for (let h of p.holder ) { %> 
                                    <% if (h.status === 'self') {
                                        if (currentUser.show_name !== '' && currentUser.show_name !== null)  { %>
                                        <div> <%= `Holder: ${currentUser.show_name}` %> <br>
                                        Contact: <%=`${currentUser.contact_info}` %> </div>
                                    <% }} else if ( h.name !== undefined && h.name !== '') {%>
                                        <% if (h.contact_info !== '') { %> 
                                            <div> <%= `Holder: ${h.name}` %> &emsp; %> <br>
                                                <%= `Contact: ${h.contact_info}` %> </div>
                                        <% } else { %>
                                            <p> No info on holder </p >                                      
                                                <% } %>
                                                <% } else { %>
                                                <% } %>
                                    <% break } %>
                                <% }}} %>
                            </div>

                            <div class="col-md-3">

                                <p> Archival: <% if (p.archival == true) { %> &#10003; <% } else { %> &#10007; <% } %>

                                <% if (p.forSale == true) { %>
                                    <p> For Sale: &#10003; </p> 
                                    <p> Price: <% for (let el of p.price) { %>
                                    <%  if (el.price !== null) { %>
                                       <span id="price-span"><%= `${el.price} ${el.currency}` %></span>  
                                        <% } else { %>
                                            not set
                                    <% }}} else { %>
                                            <p> For Sale: &#10007; </p> 
                                            <% } %> 

                            </div>
                        </div>
                    </div>


            <a href="/collection/show/<%= p._id %>/edit" class="card-link">Edit Piece</a>&emsp;<a href="/collection/show/<%=p._id%>/edit/images"  class="card-link">Edit images <i class="bi bi-images"></i></a>

            <br><br>
            <a><p class="card-link" id="export-link">Make a leflet</p></a>
            </div>
        </div>
        </div>



    </div>

</div>

<div class="row py-5 my-5 mx-4" >

    <a>
        <canvas class="canvas" id="canvas_cat" width="840" height="568"></canvas>
    </a>

</div>



<script src="./public/javascripts/transform_imgOrientation.js"></script>
   

<script>

const canvas = document.getElementById("canvas_cat");
const ctx = canvas.getContext("2d");

let pImage = document.querySelector('.image');

let pArtist = '<%- JSON.stringify(p.artist) %>'.slice(1, -1);
let pTitle = '<%- JSON.stringify(p.title) %>'.slice(1, -1);
let pCatNum = '<%- JSON.stringify(p.catalogue) %>'.slice(1, -1);
let pMedium = '<%- JSON.stringify(p.medium) %>'.slice(1, -1);

let pYear = document.getElementById('year-span').innerHTML.trim();
let pSize = document.getElementById('size-span').innerHTML.trim();
let pOwner = document.getElementById('owner-span').innerHTML.trim();
let pOContact = document.getElementById('o-contact-span').innerHTML.trim();
let pPrice = document.getElementById('price-span');


let createCanvas = async function() {

pTitle += ', ';

if (!pCatNum == 0){
pCatNum = 'Cat. ' + pCatNum;
}

if (!pOwner == 0){
    pOwner = 'Property of: ' + pOwner;
}

if (pPrice !== null) {
   pPrice = pPrice.innerHTML.trim();
}


let lineMedium = pMedium + ', ' + pSize;

let ls = 30; // line spacing
let dbls = 50;

let pieceInfo_X = 430;
let pieceInfo_Y = 220;

let ownerInfo_X = 430;
let ownerInfo_Y = 450;

let pieceImg_X = 55;
let pieceImg_Y = 160;


let catNum_X = ownerInfo_X + 60;
let catNum_Y = 80;


ctx.fillStyle = "white";
ctx.fillRect(0, 0, 840, 568);
ctx.fillStyle = "black";


ctx.font = `24px Helvetica`;
ctx.fillStyle = "#212529bf";
ctx.fillText(pCatNum, catNum_X, catNum_Y);



ctx.font = `bold 24px Lato`;
ctx.fillStyle = "#000000";
ctx.fillText(pArtist, pieceInfo_X, pieceInfo_Y);

ctx.font = 'bold italic 24px Lato'
ctx.fillText(pTitle, pieceInfo_X, pieceInfo_Y + dbls);
let titleWidth = ctx.measureText(pTitle).width;
ctx.font = '24px Lato';
ctx.fillText(pYear, pieceInfo_X + titleWidth, pieceInfo_Y + dbls);

ctx.fillStyle = "#212529bf";
ctx.fillText(lineMedium, pieceInfo_X, pieceInfo_Y + 2 * dbls);

ctx.font = '20px Lato';
ctx.fillStyle = "#000000";
ctx.fillText(pOwner, ownerInfo_X, ownerInfo_Y);
ctx.fillText(pOContact, ownerInfo_X, ownerInfo_Y + ls);

if (pPrice !== null){
    pPrice = `List price: ${pPrice}`;
ctx.fillText(pPrice, ownerInfo_X, ownerInfo_Y + 2.5 * ls)
};

if (pImage){

    if (pImage.height > pImage.width){
    pieceImg_Y -= 75
}

let imageWidth = pImage.width * 0.65;
let imageHeight = pImage.height * 0.65;

if (imageWidth > 300) {
    imageWidth = 300};


if (imageHeight > 450){
    imageHeight = 450
    };


 await ctx.drawImage(pImage, pieceImg_X, pieceImg_Y, imageWidth , imageHeight)
};

}


if (pImage){
pImage.onload = createCanvas();
} else {
    createCanvas();
}


$('#export-link').click(function(){
    
    $(this).parent().attr('href', document.getElementById('canvas_cat').toDataURL());
    $(this).parent().attr('download', `label_for_${pTitle}_by_${pArtist}.png`);    
});



    
</script>


